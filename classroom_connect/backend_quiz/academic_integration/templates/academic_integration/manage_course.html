{% extends 'academic_integration/base.html' %}

{% block title %}Manage Course - Classroom Connect{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-journal"></i> Manage Course: {{ course.name }}</h4>
            </div>
            <div class="card-body">
                {% if api_error %}
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> {{ api_error }}
                </div>
                {% endif %}
                
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab">
                            <i class="bi bi-people"></i> Students ({{ students|length }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                            <i class="bi bi-bar-chart"></i> Analytics
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="add-student-tab" data-bs-toggle="tab" data-bs-target="#add-student" type="button" role="tab">
                            <i class="bi bi-person-plus"></i> Add Student
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="add-batch-tab" data-bs-toggle="tab" data-bs-target="#add-batch" type="button" role="tab">
                            <i class="bi bi-people-fill"></i> Add Batch
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="import-csv-tab" data-bs-toggle="tab" data-bs-target="#import-csv" type="button" role="tab">
                            <i class="bi bi-file-earmark-spreadsheet"></i> Import CSV
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content p-3 border border-top-0 rounded-bottom">
                    <!-- Students Tab -->
                    <div class="tab-pane fade show active" id="students" role="tabpanel">
                        {% if students %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Roll No</th>
                                            <th>Name</th>
                                            <th>Batch</th>
                                            <th>Email</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for student in students %}
                                        <tr>
                                            <td>{{ student.rollno }}</td>
                                            <td>{{ student.name }}</td>
                                            <td>{{ student.batch }}</td>
                                            <td>{{ student.email }}</td>
                                            <td>
                                                <a href="{% url 'academic_integration:edit_student_marks' %}?course_id={{ course.id }}&student_id={{ student.rollno }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-pencil"></i> Edit Marks
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> No students enrolled in this course yet.
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Analytics Tab -->
                    <div class="tab-pane fade" id="analytics" role="tabpanel">
                        {% if api_error %}
                            <div class="alert alert-warning d-flex align-items-center" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <div>
                                    <h5>Error Loading Analytics Data</h5>
                                    <p>{{ api_error }}</p>
                                    <button class="btn btn-sm btn-warning" onclick="window.location.reload()">
                                        <i class="bi bi-arrow-clockwise"></i> Retry
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if students %}
                            <div class="row">
                                <!-- Course Summary Card -->
                                <div class="col-md-4 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">Course Summary</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mt-4">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Students:</span>
                                                    <strong>{{ students|length }}</strong>
                                                </div>
                                                {% if overall_stats %}
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Average Score:</span>
                                                    <strong>{{ overall_stats.avgScore|floatformat:1|default:"--" }}%</strong>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Tutorial Completion:</span>
                                                    <strong>{{ overall_stats.tutorialCompletionRate|floatformat:1|default:"--" }}%</strong>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Assignment Completion:</span>
                                                    <strong>{{ overall_stats.assignmentCompletionRate|floatformat:1|default:"--" }}%</strong>
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Grade Distribution -->
                                            {% if overall_stats.gradeDistribution %}
                                            <h6 class="mt-4 mb-3">Grade Distribution</h6>
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between small mb-1">
                                                    <span>A (90-100%)</span>
                                                    <span>{{ overall_stats.gradeDistribution.A|default:"0" }} students</span>
                                                </div>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-success" style="width: {{ overall_stats.grade_a_percentage }}%"></div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between small mb-1">
                                                    <span>B (80-89%)</span>
                                                    <span>{{ overall_stats.gradeDistribution.B|default:"0" }} students</span>
                                                </div>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-info" style="width: {{ overall_stats.grade_b_percentage }}%"></div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between small mb-1">
                                                    <span>C (70-79%)</span>
                                                    <span>{{ overall_stats.gradeDistribution.C|default:"0" }} students</span>
                                                </div>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-primary" style="width: {{ overall_stats.grade_c_percentage }}%"></div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between small mb-1">
                                                    <span>D (60-69%)</span>
                                                    <span>{{ overall_stats.gradeDistribution.D|default:"0" }} students</span>
                                                </div>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-warning" style="width: {{ overall_stats.grade_d_percentage }}%"></div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between small mb-1">
                                                    <span>F (<60%)</span>
                                                    <span>{{ overall_stats.gradeDistribution.F|default:"0" }} students</span>
                                                </div>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-danger" style="width: {{ overall_stats.grade_f_percentage }}%"></div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Student Performance Table -->
                                <div class="col-md-8 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">Student Performance</h5>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-hover mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Roll Number</th>
                                                            <th>Name</th>
                                                            <th title="Average of 4 tutorials (scaled to 15 marks)">Tutorials<br><span class="small">/15</span></th>
                                                            <th title="Average of 2 CAs (each out of 20 marks)">CAs<br><span class="small">/20</span></th>
                                                            <th title="Assignment & Presentation scores">Assignment<br><span class="small">/15</span></th>
                                                            <th title="Total internal marks before final conversion">Internal Total<br><span class="small">/50</span></th>
                                                            <th title="Internal marks converted to 40-mark scale">Final Internal<br><span class="small">/40</span></th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for student in students %}
                                                        <tr>
                                                            <td>{{ student.rollno }}</td>
                                                            <td>{{ student.name }}</td>
                                                            <td>{{ student.tutorialScore|floatformat:1|default:"--" }}</td>
                                                            <td>{{ student.caScore|floatformat:1|default:"--" }}</td>
                                                            <td>{{ student.assignmentScore|floatformat:1|default:"--" }}</td>
                                                            <td class="fw-bold">{{ student.internalTotal|floatformat:1|default:"--" }}</td>
                                                            <td class="fw-bold">{{ student.finalInternal|floatformat:1|default:"--" }}</td>
                                                            <td>
                                                                <a href="{% url 'academic_integration:edit_student_marks' %}?course_id={{ course.id }}&student_id={{ student.rollno }}" class="btn btn-sm btn-outline-primary">
                                                                    <i class="bi bi-pencil"></i>
                                                                </a>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Student Performance Breakdown (Detailed view per component) -->
                            <div class="card mb-4">
                                <div class="card-header bg-white">
                                    <ul class="nav nav-tabs card-header-tabs" id="performanceBreakdown" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="tutorials-tab" data-bs-toggle="tab" data-bs-target="#tutorials" 
                                                    type="button" role="tab" aria-controls="tutorials" aria-selected="true">
                                                Tutorials
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="cas-tab" data-bs-toggle="tab" data-bs-target="#cas" 
                                                    type="button" role="tab" aria-controls="cas" aria-selected="false">
                                                Continuous Assessment
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignments" 
                                                    type="button" role="tab" aria-controls="assignments" aria-selected="false">
                                                Assignments & Presentation
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="quizzes-tab" data-bs-toggle="tab" data-bs-target="#quizzes" 
                                                    type="button" role="tab" aria-controls="quizzes" aria-selected="false">
                                                Quizzes
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content" id="performanceBreakdownContent">
                                        <!-- Tutorials Tab -->
                                        <div class="tab-pane fade show active" id="tutorials" role="tabpanel" aria-labelledby="tutorials-tab">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Roll Number</th>
                                                            <th>Name</th>
                                                            <th>Tutorial 1</th>
                                                            <th>Tutorial 2</th>
                                                            <th>Tutorial 3</th>
                                                            <th>Tutorial 4</th>
                                                            <th>Average</th>
                                                            <th>Final (out of 15)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for student in students %}
                                                        <tr>
                                                            <td>{{ student.rollno }}</td>
                                                            <td>{{ student.name }}</td>
                                                            <td>{{ student.tutorial1_score|default:"—" }}</td>
                                                            <td>{{ student.tutorial2_score|default:"—" }}</td>
                                                            <td>{{ student.tutorial3_score|default:"—" }}</td>
                                                            <td>{{ student.tutorial4_score|default:"—" }}</td>
                                                            <td>{{ student.tutorial_average|floatformat:1|default:"—" }}</td>
                                                            <td class="fw-bold">{{ student.tutorialScore|floatformat:1|default:"—" }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="alert alert-info mt-3">
                                                <i class="bi bi-info-circle"></i> <strong>Tutorial Calculation:</strong> The average of 4 tutorial scores is scaled to 15 marks.
                                            </div>
                                        </div>
                                        
                                        <!-- CA Tab -->
                                        <div class="tab-pane fade" id="cas" role="tabpanel" aria-labelledby="cas-tab">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Roll Number</th>
                                                            <th>Name</th>
                                                            <th>CA1 Original (out of 50)</th>
                                                            <th>CA1 Scaled (out of 20)</th>
                                                            <th>CA2 Original (out of 50)</th>
                                                            <th>CA2 Scaled (out of 20)</th>
                                                            <th>CA Average (out of 20)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for student in students %}
                                                        <tr>
                                                            <td>{{ student.rollno }}</td>
                                                            <td>{{ student.name }}</td>
                                                            <td>{{ student.ca1_original|default:"—" }}</td>
                                                            <td>{{ student.ca1_scaled|floatformat:1|default:"—" }}</td>
                                                            <td>{{ student.ca2_original|default:"—" }}</td>
                                                            <td>{{ student.ca2_scaled|floatformat:1|default:"—" }}</td>
                                                            <td class="fw-bold">{{ student.caScore|floatformat:1|default:"—" }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="alert alert-info mt-3">
                                                <i class="bi bi-info-circle"></i> <strong>CA Calculation:</strong> Each CA is originally marked out of 50 and scaled down to 20 marks. The average of both CAs gives the final CA component mark out of 20.
                                            </div>
                                        </div>
                                        
                                        <!-- Assignments Tab -->
                                        <div class="tab-pane fade" id="assignments" role="tabpanel" aria-labelledby="assignments-tab">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Roll Number</th>
                                                            <th>Name</th>
                                                            <th>Assignment Score</th>
                                                            <th>Presentation Score</th>
                                                            <th>Total (out of 15)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for student in students %}
                                                        <tr>
                                                            <td>{{ student.rollno }}</td>
                                                            <td>{{ student.name }}</td>
                                                            <td>{{ student.assignment_score|default:"—" }}</td>
                                                            <td>{{ student.presentation_score|default:"—" }}</td>
                                                            <td class="fw-bold">{{ student.assignmentScore|floatformat:1|default:"—" }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="alert alert-info mt-3">
                                                <i class="bi bi-info-circle"></i> <strong>Assignment & Presentation Calculation:</strong> Combined score out of 15 marks.
                                            </div>
                                        </div>
                                        
                                        <!-- Quizzes Tab -->
                                        <div class="tab-pane fade" id="quizzes" role="tabpanel" aria-labelledby="quizzes-tab">
                                            {% if quiz_stats %}
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Quiz Title</th>
                                                                <th>Attempts</th>
                                                                <th>Average Score</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for quiz in quiz_stats %}
                                                            <tr>
                                                                <td>{{ quiz.title }}</td>
                                                                <td>{{ quiz.attempt_count }}</td>
                                                                <td>{{ quiz.avg_score|floatformat:1 }}%</td>
                                                                <td>
                                                                    <a href="{% url 'academic_integration:quiz_detail' quiz.quiz_id %}" class="btn btn-sm btn-outline-primary">
                                                                        <i class="bi bi-eye"></i> View Details
                                                                    </a>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            {% else %}
                                                <div class="alert alert-info">
                                                    <i class="bi bi-info-circle"></i> No quizzes have been created for this course yet.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> No students enrolled in this course yet. Analytics will be available after students are enrolled.
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Add Student Tab -->
                    <div class="tab-pane fade" id="add-student" role="tabpanel">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="single">
                            
                            {% if single_student_form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in single_student_form.non_field_errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <div class="mb-3">
                                <label for="{{ single_student_form.rollno.id_for_label }}" class="form-label">{{ single_student_form.rollno.label }}</label>
                                {{ single_student_form.rollno }}
                                {% if single_student_form.rollno.errors %}
                                <div class="text-danger">
                                    {% for error in single_student_form.rollno.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Add Student</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Add Batch Tab -->
                    <div class="tab-pane fade" id="add-batch" role="tabpanel">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="batch">
                            
                            {% if batch_form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in batch_form.non_field_errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <div class="mb-3">
                                <label for="{{ batch_form.batch.id_for_label }}" class="form-label">{{ batch_form.batch.label }}</label>
                                {{ batch_form.batch }}
                                <div class="form-text">This will add all students from the specified batch to this course.</div>
                                {% if batch_form.batch.errors %}
                                <div class="text-danger">
                                    {% for error in batch_form.batch.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary"><i class="bi bi-people-fill"></i> Add Batch</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Import CSV Tab -->
                    <div class="tab-pane fade" id="import-csv" role="tabpanel">
                        <div class="alert alert-info mb-3">
                            <h5><i class="bi bi-info-circle"></i> CSV Format Instructions</h5>
                            <p>Your CSV file should have one student roll number per line:</p>
                            <pre>{{ csv_template }}</pre>
                        </div>
                        
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="csv">
                            
                            {% if csv_form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in csv_form.non_field_errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <div class="mb-3">
                                <label for="{{ csv_form.csv_file.id_for_label }}" class="form-label">{{ csv_form.csv_file.label }}</label>
                                {{ csv_form.csv_file }}
                                {% if csv_form.csv_file.errors %}
                                <div class="text-danger">
                                    {% for error in csv_form.csv_file.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary"><i class="bi bi-upload"></i> Upload and Process CSV</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="mt-4">
                    <a href="{% url 'academic_integration:staff_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}