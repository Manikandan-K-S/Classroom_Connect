{% extends 'academic_integration/base.html' %}

{% block title %}Manage Course - Classroom Connect{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-journal"></i> Manage Course: {{ course.name }}</h4>
            </div>
            <div class="card-body">
                {% if api_error %}
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> {{ api_error }}
                </div>
                {% endif %}
                
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab">
                            <i class="bi bi-people"></i> Students ({{ students|length }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                            <i class="bi bi-bar-chart"></i> Analytics
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="add-students-tab" data-bs-toggle="tab" data-bs-target="#add-students" type="button" role="tab">
                            <i class="bi bi-person-plus-fill"></i> Add Students
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bulk-marks-tab" data-bs-toggle="tab" data-bs-target="#bulk-marks" type="button" role="tab">
                            <i class="bi bi-upload"></i> Bulk Upload Marks
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="direct-entry-tab" data-bs-toggle="tab" data-bs-target="#direct-entry" type="button" role="tab">
                            <i class="bi bi-table"></i> Direct Mark Entry
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="archive-tab" data-bs-toggle="tab" data-bs-target="#archive" type="button" role="tab">
                            <i class="bi bi-archive"></i> Archive Course
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content p-3 border border-top-0 rounded-bottom">
                    <!-- Students Tab -->
                    <div class="tab-pane fade show active" id="students" role="tabpanel">
                        {% if students %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Roll No</th>
                                            <th>Name</th>
                                            <th>Batch</th>
                                            <th>Email</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for student in students %}
                                        <tr>
                                            <td>{{ student.rollno }}</td>
                                            <td>{{ student.name }}</td>
                                            <td>{{ student.batch }}</td>
                                            <td>{{ student.email }}</td>
                                            <td>
                                                <a href="{% url 'academic_integration:edit_student_marks' %}?course_id={{ course.id }}&student_id={{ student.rollno }}" class="btn btn-sm btn-outline-primary me-1">
                                                    <i class="bi bi-pencil"></i> Edit Marks
                                                </a>
                                                <form method="post" action="{% url 'academic_integration:remove_student_from_course' course_id=course.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to remove {{ student.name }} ({{ student.rollno }}) from this course? This will also delete their performance records.');">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="student_rollno" value="{{ student.rollno }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                                        <i class="bi bi-trash"></i> Remove
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> No students enrolled in this course yet.
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Analytics Tab -->
                    <div class="tab-pane fade" id="analytics" role="tabpanel">
                        {% if api_error %}
                            <div class="alert alert-warning d-flex align-items-center" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <div>
                                    <h5>Error Loading Analytics Data</h5>
                                    <p>{{ api_error }}</p>
                                    <button class="btn btn-sm btn-warning" onclick="window.location.reload()">
                                        <i class="bi bi-arrow-clockwise"></i> Retry
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if students %}
                            <div class="row">
                                <!-- Course Summary Card -->
                                <div class="col-md-4 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">Course Summary</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mt-4">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Students:</span>
                                                    <strong>{{ students|length }}</strong>
                                                </div>
                                                {% if overall_stats %}
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Average Score:</span>
                                                    <strong>{{ overall_stats.avgScore|floatformat:1|default:"--" }}%</strong>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Tutorial Completion:</span>
                                                    <strong>{{ overall_stats.tutorialCompletionRate|floatformat:1|default:"--" }}%</strong>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Assignment Completion:</span>
                                                    <strong>{{ overall_stats.assignmentCompletionRate|floatformat:1|default:"--" }}%</strong>
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Grade Distribution -->
                                            {% if overall_stats.gradeDistribution %}
                                            <h6 class="mt-4 mb-3">Grade Distribution</h6>
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between small mb-1">
                                                    <span>A (90-100%)</span>
                                                    <span>{{ overall_stats.gradeDistribution.A|default:"0" }} students</span>
                                                </div>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-success" style="width: {{ overall_stats.grade_a_percentage }}%"></div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between small mb-1">
                                                    <span>B (80-89%)</span>
                                                    <span>{{ overall_stats.gradeDistribution.B|default:"0" }} students</span>
                                                </div>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-info" style="width: {{ overall_stats.grade_b_percentage }}%"></div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between small mb-1">
                                                    <span>C (70-79%)</span>
                                                    <span>{{ overall_stats.gradeDistribution.C|default:"0" }} students</span>
                                                </div>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-primary" style="width: {{ overall_stats.grade_c_percentage }}%"></div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between small mb-1">
                                                    <span>D (60-69%)</span>
                                                    <span>{{ overall_stats.gradeDistribution.D|default:"0" }} students</span>
                                                </div>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-warning" style="width: {{ overall_stats.grade_d_percentage }}%"></div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between small mb-1">
                                                    <span>F (<60%)</span>
                                                    <span>{{ overall_stats.gradeDistribution.F|default:"0" }} students</span>
                                                </div>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-danger" style="width: {{ overall_stats.grade_f_percentage }}%"></div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Student Performance Table -->
                                <div class="col-md-8 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">Student Performance</h5>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-hover mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Roll Number</th>
                                                            <th>Name</th>
                                                            <th title="Average of 4 tutorials (scaled to 15 marks)">Tutorials<br><span class="small">/15</span></th>
                                                            <th title="Average of 2 CAs (each out of 20 marks)">CAs<br><span class="small">/20</span></th>
                                                            <th title="Assignment & Presentation scores">Assignment<br><span class="small">/15</span></th>
                                                            <th title="Total internal marks before final conversion">Internal Total<br><span class="small">/50</span></th>
                                                            <th title="Internal marks converted to 40-mark scale">Final Internal<br><span class="small">/40</span></th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for student in students %}
                                                        <tr>
                                                            <td>{{ student.rollno }}</td>
                                                            <td>{{ student.name }}</td>
                                                            <td>{{ student.tutorialScore|floatformat:1|default:"--" }}</td>
                                                            <td>{{ student.caScore|floatformat:1|default:"--" }}</td>
                                                            <td>{{ student.assignmentScore|floatformat:1|default:"--" }}</td>
                                                            <td class="fw-bold">{{ student.internalTotal|floatformat:1|default:"--" }}</td>
                                                            <td class="fw-bold">{{ student.finalInternal|floatformat:1|default:"--" }}</td>
                                                            <td>
                                                                <a href="{% url 'academic_integration:edit_student_marks' %}?course_id={{ course.id }}&student_id={{ student.rollno }}" class="btn btn-sm btn-outline-primary">
                                                                    <i class="bi bi-pencil"></i>
                                                                </a>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Student Performance Breakdown (Detailed view per component) -->
                            <div class="card mb-4">
                                <div class="card-header bg-white">
                                    <ul class="nav nav-tabs card-header-tabs" id="performanceBreakdown" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="tutorials-tab" data-bs-toggle="tab" data-bs-target="#tutorials" 
                                                    type="button" role="tab" aria-controls="tutorials" aria-selected="true">
                                                Tutorials
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="cas-tab" data-bs-toggle="tab" data-bs-target="#cas" 
                                                    type="button" role="tab" aria-controls="cas" aria-selected="false">
                                                Continuous Assessment
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignments" 
                                                    type="button" role="tab" aria-controls="assignments" aria-selected="false">
                                                Assignments & Presentation
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="quizzes-tab" data-bs-toggle="tab" data-bs-target="#quizzes" 
                                                    type="button" role="tab" aria-controls="quizzes" aria-selected="false">
                                                Quizzes
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content" id="performanceBreakdownContent">
                                        <!-- Tutorials Tab -->
                                        <div class="tab-pane fade show active" id="tutorials" role="tabpanel" aria-labelledby="tutorials-tab">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Roll Number</th>
                                                            <th>Name</th>
                                                            <th>Tutorial 1</th>
                                                            <th>Tutorial 2</th>
                                                            <th>Tutorial 3</th>
                                                            <th>Tutorial 4</th>
                                                            <th>Average</th>
                                                            <th>Final (out of 15)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for student in students %}
                                                        <tr>
                                                            <td>{{ student.rollno }}</td>
                                                            <td>{{ student.name }}</td>
                                                            <td>{{ student.tutorial1_score|default:"—" }}</td>
                                                            <td>{{ student.tutorial2_score|default:"—" }}</td>
                                                            <td>{{ student.tutorial3_score|default:"—" }}</td>
                                                            <td>{{ student.tutorial4_score|default:"—" }}</td>
                                                            <td>{{ student.tutorial_average|floatformat:1|default:"—" }}</td>
                                                            <td class="fw-bold">{{ student.tutorialScore|floatformat:1|default:"—" }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="alert alert-info mt-3">
                                                <i class="bi bi-info-circle"></i> <strong>Tutorial Calculation:</strong> The average of 4 tutorial scores is scaled to 15 marks.
                                            </div>
                                        </div>
                                        
                                        <!-- CA Tab -->
                                        <div class="tab-pane fade" id="cas" role="tabpanel" aria-labelledby="cas-tab">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Roll Number</th>
                                                            <th>Name</th>
                                                            <th>CA1 Original (out of 50)</th>
                                                            <th>CA1 Scaled (out of 20)</th>
                                                            <th>CA2 Original (out of 50)</th>
                                                            <th>CA2 Scaled (out of 20)</th>
                                                            <th>CA Average (out of 20)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for student in students %}
                                                        <tr>
                                                            <td>{{ student.rollno }}</td>
                                                            <td>{{ student.name }}</td>
                                                            <td>{{ student.ca1_original|default:"—" }}</td>
                                                            <td>{{ student.ca1_scaled|floatformat:1|default:"—" }}</td>
                                                            <td>{{ student.ca2_original|default:"—" }}</td>
                                                            <td>{{ student.ca2_scaled|floatformat:1|default:"—" }}</td>
                                                            <td class="fw-bold">{{ student.caScore|floatformat:1|default:"—" }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="alert alert-info mt-3">
                                                <i class="bi bi-info-circle"></i> <strong>CA Calculation:</strong> Each CA is originally marked out of 50 and scaled down to 20 marks. The average of both CAs gives the final CA component mark out of 20.
                                            </div>
                                        </div>
                                        
                                        <!-- Assignments Tab -->
                                        <div class="tab-pane fade" id="assignments" role="tabpanel" aria-labelledby="assignments-tab">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Roll Number</th>
                                                            <th>Name</th>
                                                            <th>Assignment Score</th>
                                                            <th>Presentation Score</th>
                                                            <th>Total (out of 15)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for student in students %}
                                                        <tr>
                                                            <td>{{ student.rollno }}</td>
                                                            <td>{{ student.name }}</td>
                                                            <td>{{ student.assignment_score|default:"—" }}</td>
                                                            <td>{{ student.presentation_score|default:"—" }}</td>
                                                            <td class="fw-bold">{{ student.assignmentScore|floatformat:1|default:"—" }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="alert alert-info mt-3">
                                                <i class="bi bi-info-circle"></i> <strong>Assignment & Presentation Calculation:</strong> Combined score out of 15 marks.
                                            </div>
                                        </div>
                                        
                                        <!-- Quizzes Tab -->
                                        <div class="tab-pane fade" id="quizzes" role="tabpanel" aria-labelledby="quizzes-tab">
                                            {% if quiz_stats %}
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Quiz Title</th>
                                                                <th>Attempts</th>
                                                                <th>Average Score</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for quiz in quiz_stats %}
                                                            <tr>
                                                                <td>{{ quiz.title }}</td>
                                                                <td>{{ quiz.attempt_count }}</td>
                                                                <td>{{ quiz.avg_score|floatformat:1 }}%</td>
                                                                <td>
                                                                    <a href="{% url 'academic_integration:quiz_detail' quiz.quiz_id %}" class="btn btn-sm btn-outline-primary">
                                                                        <i class="bi bi-eye"></i> View Details
                                                                    </a>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            {% else %}
                                                <div class="alert alert-info">
                                                    <i class="bi bi-info-circle"></i> No quizzes have been created for this course yet.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> No students enrolled in this course yet. Analytics will be available after students are enrolled.
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Add Students Tab (Combined) -->
                    <div class="tab-pane fade" id="add-students" role="tabpanel">
                        <div class="row">
                            <!-- Add Single Student -->
                            <div class="col-lg-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="bi bi-person-plus"></i> Add Single Student</h5>
                                    </div>
                                    <div class="card-body">
                                        <form method="post">
                                            {% csrf_token %}
                                            <input type="hidden" name="form_type" value="single">
                                            
                                            {% if single_student_form.non_field_errors %}
                                            <div class="alert alert-danger">
                                                {% for error in single_student_form.non_field_errors %}
                                                {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            
                                            <div class="mb-3">
                                                <label for="{{ single_student_form.rollno.id_for_label }}" class="form-label">{{ single_student_form.rollno.label }}</label>
                                                {{ single_student_form.rollno }}
                                                <div class="form-text">Enter the student's roll number</div>
                                                {% if single_student_form.rollno.errors %}
                                                <div class="text-danger">
                                                    {% for error in single_student_form.rollno.errors %}
                                                    {{ error }}
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="bi bi-plus-circle"></i> Add Student
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Add Batch -->
                            <div class="col-lg-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="bi bi-people-fill"></i> Add Batch</h5>
                                    </div>
                                    <div class="card-body">
                                        <form method="post">
                                            {% csrf_token %}
                                            <input type="hidden" name="form_type" value="batch">
                                            
                                            {% if batch_form.non_field_errors %}
                                            <div class="alert alert-danger">
                                                {% for error in batch_form.non_field_errors %}
                                                {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            
                                            <div class="mb-3">
                                                <label for="{{ batch_form.batch.id_for_label }}" class="form-label">{{ batch_form.batch.label }}</label>
                                                {{ batch_form.batch }}
                                                <div class="form-text">Add all students from a specific batch to this course</div>
                                                {% if batch_form.batch.errors %}
                                                <div class="text-danger">
                                                    {% for error in batch_form.batch.errors %}
                                                    {{ error }}
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-success">
                                                    <i class="bi bi-people-fill"></i> Add Batch
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Import CSV -->
                            <div class="col-lg-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="bi bi-file-earmark-spreadsheet"></i> Import CSV</h5>
                                    </div>
                                    <div class="card-body">
                                        <form method="post" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <input type="hidden" name="form_type" value="csv">
                                            
                                            {% if csv_form.non_field_errors %}
                                            <div class="alert alert-danger">
                                                {% for error in csv_form.non_field_errors %}
                                                {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            
                                            <div class="mb-3">
                                                <label for="{{ csv_form.csv_file.id_for_label }}" class="form-label">{{ csv_form.csv_file.label }}</label>
                                                <input type="file" class="form-control" id="{{ csv_form.csv_file.id_for_label }}" name="csv_file" accept=".csv,.xlsx,.xls" required>
                                                <div class="form-text">Upload CSV or Excel file with roll numbers</div>
                                                {% if csv_form.csv_file.errors %}
                                                <div class="text-danger">
                                                    {% for error in csv_form.csv_file.errors %}
                                                    {{ error }}
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="alert alert-light border mb-3">
                                                <small>
                                                    <strong>Format:</strong> One roll number per line<br>
                                                    <code>{{ csv_template }}</code>
                                                </small>
                                            </div>
                                            
                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-info text-white">
                                                    <i class="bi bi-upload"></i> Upload Students
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bulk Upload Marks Tab -->
                    <div class="tab-pane fade" id="bulk-marks" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-download"></i> Step 1: Download Template</h5>
                            </div>
                            <div class="card-body">
                                <p>Select which mark columns you want to include in the template:</p>
                                
                                <form method="get" action="{% url 'academic_integration:download_marks_template' course.courseId %}">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <h6 class="fw-bold mb-2">Tutorials</h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="include_tutorial1" id="include_tutorial1">
                                                <label class="form-check-label" for="include_tutorial1">Tutorial 1</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="include_tutorial2" id="include_tutorial2">
                                                <label class="form-check-label" for="include_tutorial2">Tutorial 2</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="include_tutorial3" id="include_tutorial3">
                                                <label class="form-check-label" for="include_tutorial3">Tutorial 3</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="include_tutorial4" id="include_tutorial4">
                                                <label class="form-check-label" for="include_tutorial4">Tutorial 4</label>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <h6 class="fw-bold mb-2">Assessments</h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="include_ca1" id="include_ca1">
                                                <label class="form-check-label" for="include_ca1">CA 1</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="include_ca2" id="include_ca2">
                                                <label class="form-check-label" for="include_ca2">CA 2</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="include_assignment" id="include_assignment">
                                                <label class="form-check-label" for="include_assignment">Assignment/Presentation</label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> <strong>Template will include:</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>Roll Number (required - student identifier)</li>
                                            <li>Name (read-only - for reference)</li>
                                            <li>Selected mark columns (editable)</li>
                                        </ul>
                                        <small>Leave cells blank for marks you don't want to update. Only filled cells will be updated.</small>
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-success">
                                            <i class="bi bi-download"></i> Download Selected Template
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-upload"></i> Step 2: Upload Completed Template</h5>
                            </div>
                            <div class="card-body">
                                <form method="post" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <input type="hidden" name="form_type" value="bulk_marks">
                                    
                                    {% if bulk_marks_errors %}
                                    <div class="alert alert-danger">
                                        <h6>Upload Errors:</h6>
                                        <ul class="mb-0">
                                            {% for error in bulk_marks_errors %}
                                            <li>{{ error }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                    
                                    {% if bulk_marks_success %}
                                    <div class="alert alert-success">
                                        <i class="bi bi-check-circle"></i> {{ bulk_marks_success }}
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mb-3">
                                        <label for="marks_csv_file" class="form-label">Select File (CSV or Excel)</label>
                                        <input type="file" class="form-control" id="marks_csv_file" name="marks_csv_file" accept=".csv,.xlsx,.xls" required>
                                        <div class="form-text">Upload CSV or Excel file with student marks. The system will automatically detect column headers.</div>
                                    </div>
                                    
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle"></i> <strong>Important:</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>Only fill in the marks columns you want to update</li>
                                            <li>Do not modify Roll Number or Name columns</li>
                                            <li>Marks should be numeric values (0-10)</li>
                                            <li>The system will match column names like: tutorial1, Tutorial 1, CA1, CA 1, assignment, etc.</li>
                                            <li><strong>Supported formats:</strong> CSV (.csv) or Excel (.xlsx, .xls)</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="bi bi-upload"></i> Upload and Update Marks
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Direct Mark Entry Tab -->
                    <div class="tab-pane fade" id="direct-entry" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-table"></i> Direct Mark Entry</h5>
                            </div>
                            <div class="card-body">
                                {% if students %}
                                <form method="post" id="direct-marks-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="form_type" value="direct_marks">
                                    
                                    {% if direct_marks_errors %}
                                    <div class="alert alert-danger">
                                        <h6>Errors:</h6>
                                        <ul class="mb-0">
                                            {% for error in direct_marks_errors %}
                                            <li>{{ error }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                    
                                    {% if direct_marks_success %}
                                    <div class="alert alert-success">
                                        <i class="bi bi-check-circle"></i> {{ direct_marks_success }}
                                    </div>
                                    {% endif %}
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="mark_component" class="form-label fw-bold">Select Mark Component *</label>
                                            <select class="form-select" id="mark_component" name="mark_component" required onchange="updateTotalMarks()">
                                                <option value="">-- Select Component --</option>
                                                <option value="tutorial1">Tutorial 1</option>
                                                <option value="tutorial2">Tutorial 2</option>
                                                <option value="tutorial3">Tutorial 3</option>
                                                <option value="tutorial4">Tutorial 4</option>
                                                <option value="ca1">CA 1 (50 marks)</option>
                                                <option value="ca2">CA 2 (50 marks)</option>
                                                <option value="assignment">Assignment/Presentation (15 marks)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="total_marks" class="form-label fw-bold">Total Marks (Test Out Of) *</label>
                                            <input type="number" class="form-control" id="total_marks" name="total_marks" 
                                                   min="1" max="100" step="0.01" value="10" required
                                                   onchange="updateMarkInputs()">
                                            <small class="form-text text-muted" id="total_marks_info">Marks will be converted to equivalent out of 10</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Quick Actions</label>
                                            <div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="clearAllMarks()">
                                                    <i class="bi bi-x-circle"></i> Clear All
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-info" onclick="fillAbsent()">
                                                    <i class="bi bi-dash-circle"></i> Mark Absent (0)
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> 
                                        Enter marks in actual test scores. They will be automatically converted to equivalent marks out of 10.
                                        <strong id="conversion-info">Example: If test is out of 25, entering 20 = 8.0/10</strong>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 5%">#</th>
                                                    <th style="width: 15%">Roll Number</th>
                                                    <th style="width: 40%">Name</th>
                                                    <th style="width: 20%">Mark <span id="marks-range">(0-10)</span></th>
                                                    <th style="width: 20%">Equivalent /10</th>
                                                </tr>
                                            </thead>
                                            <tbody id="marks-table-body">
                                                {% for student in sorted_students %}
                                                <tr>
                                                    <td class="text-center">{{ forloop.counter }}</td>
                                                    <td><strong>{{ student.rollno }}</strong></td>
                                                    <td>{{ student.name }}</td>
                                                    <td>
                                                        <input type="hidden" name="student_rollno_{{ forloop.counter }}" value="{{ student.rollno }}">
                                                        <input type="hidden" name="student_email_{{ forloop.counter }}" value="{{ student.email }}">
                                                        <input type="number" 
                                                               class="form-control form-control-sm mark-input" 
                                                               id="mark_input_{{ forloop.counter }}"
                                                               name="mark_{{ forloop.counter }}" 
                                                               min="0" 
                                                               max="10" 
                                                               step="0.01"
                                                               oninput="calculateEquivalent({{ forloop.counter }})"
                                                               placeholder="0-10">
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary equivalent-mark" id="equiv_{{ forloop.counter }}">-</span>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="d-grid gap-2 mt-3">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="bi bi-save"></i> Save Marks
                                        </button>
                                    </div>
                                </form>
                                {% else %}
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> No students enrolled in this course yet.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Archive Course Tab -->
                <div class="tab-pane fade" id="archive" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="bi bi-archive"></i> Archive Course</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <h5 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Archive Course</h5>
                                <p>Archiving a course will:</p>
                                <ul>
                                    <li>Remove it from your active courses dashboard</li>
                                    <li>Hide it from quiz creation course selection</li>
                                    <li>Preserve all student enrollment and marks data</li>
                                    <li>Make it read-only (no mark modifications allowed)</li>
                                    <li>Allow you to restore it later if needed</li>
                                </ul>
                                <hr>
                                <p class="mb-0"><strong>Note:</strong> Archived courses can be viewed from the "Archived Courses" section in the dashboard.</p>
                            </div>
                            
                            <div class="card border-danger">
                                <div class="card-header bg-danger text-white">
                                    <strong>Confirm Archive</strong>
                                </div>
                                <div class="card-body">
                                    <p>Course: <strong>{{ course.name }} ({{ course.id }})</strong></p>
                                    <p>Enrolled Students: <strong>{{ students|length }}</strong></p>
                                    
                                    <form method="post" action="{% url 'academic_integration:archive_course' course_id=course.id %}" 
                                          onsubmit="return confirm('Are you sure you want to archive this course? This action will remove it from your active courses.');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger">
                                            <i class="bi bi-archive"></i> Archive This Course
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script>
                    // Update total marks based on component selection
                    function updateTotalMarks() {
                        const component = document.getElementById('mark_component').value;
                        const totalMarksInput = document.getElementById('total_marks');
                        const totalMarksInfo = document.getElementById('total_marks_info');
                        
                        // Set total marks based on component
                        if (component === 'ca1' || component === 'ca2') {
                            totalMarksInput.value = 50;
                            totalMarksInput.disabled = true;
                            totalMarksInfo.textContent = 'Fixed at 50 marks (converted to /10)';
                            totalMarksInfo.className = 'form-text text-info fw-bold';
                        } else if (component === 'assignment') {
                            totalMarksInput.value = 15;
                            totalMarksInput.disabled = true;
                            totalMarksInfo.textContent = 'Fixed at 15 marks (converted to /10)';
                            totalMarksInfo.className = 'form-text text-info fw-bold';
                        } else if (component.startsWith('tutorial')) {
                            totalMarksInput.value = 10;
                            totalMarksInput.disabled = false;
                            totalMarksInfo.textContent = 'Enter the total marks for this tutorial';
                            totalMarksInfo.className = 'form-text text-muted';
                        } else {
                            totalMarksInput.value = 10;
                            totalMarksInput.disabled = false;
                            totalMarksInfo.textContent = 'Marks will be converted to equivalent out of 10';
                            totalMarksInfo.className = 'form-text text-muted';
                        }
                        
                        // Update the mark inputs with new range
                        updateMarkInputs();
                    }
                    
                    // Calculate equivalent mark out of 10
                    function calculateEquivalent(counter) {
                        const totalMarks = parseFloat(document.getElementById('total_marks').value) || 10;
                        const markInput = document.getElementById(`mark_input_${counter}`);
                        const equivSpan = document.getElementById(`equiv_${counter}`);
                        
                        if (markInput.value) {
                            const actualMark = parseFloat(markInput.value);
                            const equivalent = (actualMark / totalMarks) * 10;
                            equivSpan.textContent = equivalent.toFixed(2);
                            equivSpan.className = 'badge bg-success';
                        } else {
                            equivSpan.textContent = '-';
                            equivSpan.className = 'badge bg-secondary';
                        }
                    }
                    
                    // Update mark input ranges when total marks changes
                    function updateMarkInputs() {
                        const totalMarks = parseFloat(document.getElementById('total_marks').value) || 10;
                        const marksRange = document.getElementById('marks-range');
                        const conversionInfo = document.getElementById('conversion-info');
                        
                        marksRange.textContent = `(0-${totalMarks})`;
                        
                        // Update example conversion
                        const exampleMark = Math.round(totalMarks * 0.8 * 100) / 100;
                        const exampleEquiv = ((exampleMark / totalMarks) * 10).toFixed(1);
                        conversionInfo.innerHTML = `<strong>Example: If test is out of ${totalMarks}, entering ${exampleMark} = ${exampleEquiv}/10</strong>`;
                        
                        // Update all input max values
                        document.querySelectorAll('.mark-input').forEach(input => {
                            input.max = totalMarks;
                            // Recalculate equivalents for filled inputs
                            const counter = input.id.replace('mark_input_', '');
                            if (input.value) {
                                calculateEquivalent(counter);
                            }
                        });
                    }
                    
                    function clearAllMarks() {
                        document.querySelectorAll('.mark-input').forEach(input => {
                            input.value = '';
                            const counter = input.id.replace('mark_input_', '');
                            const equivSpan = document.getElementById(`equiv_${counter}`);
                            if (equivSpan) {
                                equivSpan.textContent = '-';
                                equivSpan.className = 'badge bg-secondary';
                            }
                        });
                    }
                    
                    function fillAbsent() {
                        if (confirm('Mark all students as absent (0 marks)?')) {
                            document.querySelectorAll('.mark-input').forEach(input => {
                                input.value = '0';
                                const counter = input.id.replace('mark_input_', '');
                                calculateEquivalent(counter);
                            });
                        }
                    }
                    
                    // Preserve active tab after page reload
                    document.addEventListener('DOMContentLoaded', function() {
                        // Initialize on page load
                        updateMarkInputs();
                        
                        // Check if there's a hash in the URL or a saved tab
                        const hash = window.location.hash || localStorage.getItem('activeTab');
                        if (hash) {
                            const tabTrigger = document.querySelector(`a[href="${hash}"]`);
                            if (tabTrigger) {
                                const tab = new bootstrap.Tab(tabTrigger);
                                tab.show();
                            }
                        }
                        
                        // Save active tab when switching
                        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(button => {
                            button.addEventListener('shown.bs.tab', function (event) {
                                const targetId = event.target.getAttribute('data-bs-target');
                                localStorage.setItem('activeTab', targetId);
                                window.location.hash = targetId;
                            });
                        });
                        
                        // Check for success/error messages to show appropriate tab
                        {% if bulk_marks_errors or bulk_marks_success %}
                        const bulkTab = document.querySelector('button[data-bs-target="#bulk-upload"]');
                        if (bulkTab) {
                            const tab = new bootstrap.Tab(bulkTab);
                            tab.show();
                        }
                        {% endif %}
                        
                        {% if direct_marks_errors or direct_marks_success %}
                        const directTab = document.querySelector('button[data-bs-target="#direct-entry"]');
                        if (directTab) {
                            const tab = new bootstrap.Tab(directTab);
                            tab.show();
                        }
                        {% endif %}
                    });
                </script>
                
                <div class="mt-4">
                    <a href="{% url 'academic_integration:staff_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}