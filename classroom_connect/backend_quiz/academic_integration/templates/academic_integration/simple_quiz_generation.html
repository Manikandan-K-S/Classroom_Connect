{% extends "academic_integration/base.html" %}
{% load static %}

{% block title %}Simple Quiz Generation with Gemini{% endblock %}

{% block extra_head %}
<script src="{% static 'academic_integration/js/directGeminiQuizGenerator.js' %}"></script>
<script src="{% static 'academic_integration/js/quiz_api_debugger.js' %}"></script>
<script src="{% static 'academic_integration/js/gemini_debug_helper.js' %}"></script>
<script src="{% static 'academic_integration/js/simple-quiz-direct-test.js' %}"></script>
<style>
    .form-section {
        margin-bottom: 30px;
    }
    .file-upload-wrapper {
        border: 2px dashed #ccc;
        padding: 25px;
        text-align: center;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .drag-text {
        font-size: 18px;
        color: #666;
        margin-bottom: 15px;
    }
    .file-info {
        margin-top: 15px;
        display: none;
    }
    .spinner-border {
        width: 1.5rem;
        height: 1.5rem;
        display: inline-block;
        vertical-align: middle;
        border: 0.2em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border .75s linear infinite;
    }
    @keyframes spinner-border {
        to { transform: rotate(360deg); }
    }
    
    /* Loading overlay styles */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.3s linear;
        -webkit-backdrop-filter: blur(5px);
        backdrop-filter: blur(5px);
    }
    
    .loading-overlay.show {
        visibility: visible !important;
        opacity: 1 !important;
        display: flex !important;
    }
    
    .large-spinner {
        width: 4rem;
        height: 4rem;
        border-width: 0.3em;
    }
    
    .loading-text {
        margin-top: 1rem;
        font-size: 1.2rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="spinner-border large-spinner" role="status">
        <span class="sr-only">Loading...</span>
    </div>
    <div class="loading-text">Generating quiz questions with Gemini AI...</div>
    <p class="text-light mt-3">This may take a minute or two depending on the content length.</p>
</div>

<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Simple Quiz Generation with Gemini</h1>
            <div class="alert alert-info">
                <p>This tool allows you to quickly generate quiz questions from educational materials using Google's Gemini AI.</p>
                <p>Simply upload a file, provide basic quiz details, and the system will generate questions and create a quiz for you.</p>
            </div>
            
            {% if not api_key_available %}
            <div class="alert alert-warning">
                <h4><i class="bi bi-exclamation-triangle-fill"></i> API Key Not Configured</h4>
                <p>The Gemini API key is not configured. Quiz generation will not work until this is fixed.</p>
                <p><strong>Administrator action required:</strong> Add the GEMINI_API_KEY environment variable with a valid Google AI API key.</p>
            </div>
            {% endif %}

            <div id="status-messages"></div>

            <div class="card">
                <div class="card-body">
                    <form id="quiz-generation-form">
                        {% csrf_token %}

                        <!-- File Upload Section -->
                        <div class="form-section">
                            <h3>1. Upload Educational Material</h3>
                            <div class="file-upload-wrapper" id="drop-area">
                                <div class="drag-text">Drag & drop your file here or click to browse</div>
                                <label for="file-input" class="sr-only">Upload educational content file</label>
                                <input type="file" id="file-input" class="form-control-file" accept=".pdf,.docx,.txt" aria-describedby="file-type-help" />
                                <div class="file-info" id="file-info"></div>
                            </div>
                            <small id="file-type-help" class="text-muted">Supported file types: PDF, DOCX, and TXT</small>
                        </div>

                        <!-- Quiz Details Section -->
                        <div class="form-section">
                            <h3>2. Quiz Details</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="quiz-title">Quiz Title</label>
                                        <input type="text" id="quiz-title" class="form-control" required placeholder="Enter a title for your quiz" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="course-id">Course (Optional)</label>
                                        <select id="course-id" class="form-control">
                                            <option value="">-- No Course --</option>
                                            {% for course in courses %}
                                            <option value="{{ course.courseId }}">{{ course.courseName }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="quiz-description">Description (Optional)</label>
                                <textarea id="quiz-description" class="form-control" rows="2" placeholder="Enter a description for your quiz"></textarea>
                            </div>
                        </div>

                        <!-- Question Generation Options -->
                        <div class="form-section">
                            <h3>3. Question Options</h3>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="num-questions">Number of Questions</label>
                                        <input type="number" id="num-questions" class="form-control" min="1" max="20" value="5" required />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="difficulty">Difficulty Level</label>
                                        <select id="difficulty" class="form-control">
                                            <option value="easy">Easy</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="duration-minutes">Duration (minutes)</label>
                                        <input type="number" id="duration-minutes" class="form-control" min="5" value="30" required />
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Question Types</label>
                                <div class="form-check">
                                    <input type="checkbox" id="type-mcq-single" class="form-check-input" checked />
                                    <label class="form-check-label" for="type-mcq-single">Multiple Choice (Single Answer)</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" id="type-mcq-multiple" class="form-check-input" checked />
                                    <label class="form-check-label" for="type-mcq-multiple">Multiple Choice (Multiple Answers)</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" id="type-true-false" class="form-check-input" checked />
                                    <label class="form-check-label" for="type-true-false">True/False</label>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg">Generate Quiz</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const fileInfo = document.getElementById('file-info');
    const quizForm = document.getElementById('quiz-generation-form');
    
    // Create status element for updates
    const status = DirectGeminiQuizGenerator.createStatusElement('generation-status', '#status-messages');
    
    // Handle file selection
    let selectedFile = null;
    
    fileInput.addEventListener('change', function(e) {
        if (this.files && this.files.length > 0) {
            selectedFile = this.files[0];
            displayFileInfo(selectedFile);
        }
    });
    
    // Handle drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropArea.style.borderColor = '#007bff';
        dropArea.style.backgroundColor = 'rgba(0, 123, 255, 0.05)';
    }
    
    function unhighlight() {
        dropArea.style.borderColor = '#ccc';
        dropArea.style.backgroundColor = '';
    }
    
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        selectedFile = dt.files[0];
        fileInput.files = dt.files;
        displayFileInfo(selectedFile);
    }
    
    function displayFileInfo(file) {
        if (!file) return;
        
        fileInfo.style.display = 'block';
        fileInfo.innerHTML = `
            <strong>Selected file:</strong> ${file.name} <br>
            <strong>Type:</strong> ${file.type} <br>
            <strong>Size:</strong> ${formatFileSize(file.size)}
        `;
    }
    
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' bytes';
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        else return (bytes / 1048576).toFixed(1) + ' MB';
    }
    
    // Function to show/hide loading overlay
    function showLoading(show) {
        const overlay = document.getElementById('loading-overlay');
        console.log(`Attempting to ${show ? 'show' : 'hide'} loading overlay`);
        
        if (show) {
            overlay.style.display = 'flex';
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
            console.log('Loading overlay should now be visible');
        } else {
            overlay.classList.remove('show');
            document.body.style.overflow = ''; // Restore scrolling
            console.log('Loading overlay should now be hidden');
            
            // Double-check that it's hidden after a short delay
            setTimeout(() => {
                if (overlay.classList.contains('show')) {
                    console.warn('Loading overlay is still visible, forcing hide');
                    overlay.classList.remove('show');
                    overlay.style.display = 'none';
                }
            }, 500);
            
            // Completely hide after transition
            setTimeout(() => {
                if (!overlay.classList.contains('show')) {
                    overlay.style.display = 'none';
                }
            }, 350);
        }
    }
    
    // Handle form submission
    quizForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!selectedFile) {
            alert('Please select a file first');
            return;
        }
        
        // Collect question types
        const questionTypes = [];
        if (document.getElementById('type-mcq-single').checked) questionTypes.push('mcq_single');
        if (document.getElementById('type-mcq-multiple').checked) questionTypes.push('mcq_multiple');
        if (document.getElementById('type-true-false').checked) questionTypes.push('true_false');
        
        if (questionTypes.length === 0) {
            alert('Please select at least one question type');
            return;
        }
        
        // Show loading overlay
        showLoading(true);
        
        // Show loading status in the status area too
        status.showLoading('Generating questions and creating quiz...');
        
        // Disable submit button to prevent double-submission
        const submitButton = quizForm.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating Quiz...';
        
        // Collect form data
        const options = {
            quizTitle: document.getElementById('quiz-title').value,
            quizDescription: document.getElementById('quiz-description').value,
            courseId: document.getElementById('course-id').value,
            numQuestions: parseInt(document.getElementById('num-questions').value),
            difficulty: document.getElementById('difficulty').value,
            questionTypes: questionTypes,
            durationMinutes: parseInt(document.getElementById('duration-minutes').value)
        };
        
        try {
            console.log('Attempting to create quiz with options:', options);
            
            // Validate that we have a CSRF token
            const csrfToken = DirectGeminiQuizGenerator.getCsrfToken();
            if (!csrfToken) {
                throw new Error('CSRF token not found. Please refresh the page and try again.');
            }
            
            // Call the generator
            const result = await DirectGeminiQuizGenerator.createQuizFromFile(selectedFile, options);
            console.log('Quiz creation response:', result);
            
            // Hide loading overlay
            showLoading(false);
            
            if (!result || !result.quiz_id) {
                throw new Error('Server returned an incomplete response. Quiz may not have been created properly.');
            }
            
            // Show success message
            status.showSuccess(`Quiz "${options.quizTitle}" created successfully with ${result.question_count} questions!`);
            
            // Add link to view the quiz
            const linkHtml = `<div class="mt-3"><a href="/academic_integration/staff/quiz/${result.quiz_id}/edit/" class="btn btn-primary">View & Edit Quiz</a></div>`;
            document.getElementById('status-messages').innerHTML += linkHtml;
            
            // Redirect after a short delay
            setTimeout(() => {
                window.location.href = '/academic_integration/staff/quiz/' + result.quiz_id + '/edit/';
            }, 2000);
            
        } catch (error) {
            console.error('Error creating quiz:', error);
            
            // Hide loading overlay
            showLoading(false);
            
            // Re-enable submit button
            submitButton.disabled = false;
            submitButton.innerHTML = 'Generate Quiz';
            
            // Show detailed error message
            let errorMessage = error.message || 'Unknown error';
            if (errorMessage.includes('Failed to fetch') || error.name === 'TypeError') {
                errorMessage = 'Network error. Please check your internet connection and try again.';
            } else if (errorMessage.includes('401')) {
                errorMessage = 'Authentication error. Please log in again and try again.';
            } else if (errorMessage.includes('500')) {
                errorMessage = 'Server error. The system may be experiencing technical difficulties. Please try again later.';
            } else if (errorMessage.includes('timeout') || errorMessage.includes('timed out')) {
                errorMessage = 'The request timed out. The content may be too large or the server may be busy. Please try again with a smaller document or try later.';
            } else if (errorMessage.includes('API key')) {
                errorMessage = 'Gemini API key error. Please contact your administrator to configure the API key properly.';
            }
            
            // Check for API key missing specifically
            if (!document.querySelector('.alert-warning') && errorMessage.includes('API key')) {
                const apiKeyAlert = document.createElement('div');
                apiKeyAlert.className = 'alert alert-warning';
                apiKeyAlert.innerHTML = `
                    <h4><i class="bi bi-exclamation-triangle-fill"></i> API Key Not Configured</h4>
                    <p>The Gemini API key is not configured or invalid. Quiz generation will not work until this is fixed.</p>
                    <p><strong>Administrator action required:</strong> Add the GEMINI_API_KEY environment variable with a valid Google AI API key.</p>
                `;
                document.getElementById('status-messages').appendChild(apiKeyAlert);
            }
            
            status.showError(`Failed to create quiz: ${errorMessage}`);
            
            // Add a retry button
            const retryHtml = `<div class="mt-3"><button class="btn btn-outline-primary" onclick="location.reload()">Try Again</button></div>`;
            document.getElementById('status-messages').innerHTML += retryHtml;
        }
    });
});
</script>
{% endblock %}